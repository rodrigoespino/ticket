SELECT        dbo.FAT_TCADNOTFIS.CODEMP, dbo.FAT_TCADCABDOCENT.CODCABDOCENT, ISNULL(dbo.FAT_TCADCABDOCENT.VALRETIMP, 0) AS VALRETIMP, 
                         dbo.FAT_TTABEMP.RAZSOC, dbo.FAT_TCADFIL.CODREG, dbo.FAT_TCADFIL.CODFIL, dbo.FAT_TCADFIL.NOMFIL, MUNFIL.NOMMUN AS MUNFIL, 
                         MUNFIL.CODUF AS UFFIL, dbo.FAT_TCADFIL.[END] AS ENDFIL, dbo.FAT_TCADFIL.NUMEND AS NUMFIL, dbo.FAT_TCADFIL.COMEND AS COMFIL, 
                         dbo.FAT_TCADFIL.BAI AS BAIFIL, dbo.FAT_TCADFIL.CNP AS CNDPFIL, dbo.FAT_TCADFIL.INSEST AS INSESTFIL, 
                         LTRIM(RTRIM(STR(dbo.FAT_TCADNOTFIS.CODNOTFIS))) AS CODNOTFIS, dbo.FAT_TCADNOTFIS.CODCLI, CAST(dbo.FAT_TCADNOTFIS.MESCOP AS VARCHAR(2)) 
                         AS MESCOP, CAST(dbo.FAT_TCADNOTFIS.ANOCOP AS VARCHAR(4)) AS ANOCOP, dbo.FAT_TCADNOTFIS.CODLOTFAT, ISNULL(dbo.FAT_TCADNOTFIS.NUMNFE, 
                         dbo.FAT_TCADNOTFIS.NUMNOTFIS) AS NUMNOTFIS, dbo.FAT_TCADNOTFIS.VALTOTNOTFIS, dbo.FAT_TCADSOLSER.CODSOLSER, 
                         dbo.FAT_TCADSOLSER.NUMCTRCLI, dbo.FAT_TTABFAM.CODFAM, dbo.FAT_TTABFAM.DESFAM, dbo.FAT_FPONATEOPE(PONORI.CODPONATE, 
                         PONDES.CODPONATE) AS TIPOPE, FAT_TCADSEG_1.CODSEG, FAT_TCADSEG_1.DESSEG, dbo.FAT_TTABMOA.DESMOA, 
                         dbo.FAT_TCADSERPONENV.CODSERPONENV, 
                         CASE WHEN TB_CODCALFAT.MIN_EXCED > 0 THEN TB_CODCALFAT.MIN_EXCED / TB_CODCALFAT.MIN_EXCEDVALUNT ELSE 0 END AS QTDMINUTOSEXC, 
                         CLIPONFAT.CODCLI AS CODCLIFAT, CLIPONFAT.NOMCLI AS NOMCLIFAT, CLIPONFAT.NOMCLI AS NOMABRCLIFAT, ISNULL(CAST(PONFAT.CODCLI AS VARCHAR), 0) 
                         + '/' + ISNULL(CAST(PONFAT.NUMPONATE AS VARCHAR), 0) + '/' + ISNULL(CAST(PONFAT.NUMPOSATE AS VARCHAR), 0) 
                         + '/' + ISNULL(CAST(PONFAT.NUMATM AS VARCHAR), 0) + '  ' AS PONTOFATURAR, PONFAT.CODPONATE AS CODPONFAT, PONFAT.NUMPONATE AS NUMPONATEFAT, 
                         PONFAT.NUMPOSATE AS PUNTOFACTURACION, PONFAT.NUMATM AS NUMATMFACT, PONFAT.NOMPON AS NOMPUNFAT, ENDPUNFAT.ENDPONATE AS ENDFAT, 
                         ENDPONFAT.NUMEND AS NUMFAT, ENDPONFAT.COMEND AS COMFAT, ENDPONFAT.BAI AS BAIFAT, MUNPONFAT.NOMMUN AS MUNFAT, UFFAT.CODUF AS UFFAT, 
                         UFFAT.DESUF AS DESUFFAT, FILPONFAT.CODFIL AS CODFILPONFAT, FILPONFAT.NOMFIL AS NOMFILPONFAT, TIPLOGPONFAT.DESABRTIPLOG AS LOGFAT, 
                         CLIPONCEN.CODCLI AS CODCLICEN, CLIPONCEN.NOMCLI AS NOMCLICEN, CLIPONCEN.NOMABRCLI AS NOMABRCLICEN, 
                         ISNULL(CAST(PONCEN.CODCLI AS VARCHAR), 0) + '/' + ISNULL(CAST(PONCEN.NUMPONATE AS VARCHAR), 0) 
                         + '/' + ISNULL(CAST(PONCEN.NUMPOSATE AS VARCHAR), 0) + '/' + ISNULL(CAST(PONCEN.NUMATM AS VARCHAR), 0) + '  ' AS PONTOCUSTO, 
                         PONCEN.CODPONATE AS CODPONCEN, PONCEN.NUMPONATE AS NUMPONATECEN, PONCEN.NUMPOSATE AS NUMPOSATECEN, 
                         PONCEN.NUMATM AS NUMATMCEN, PONCEN.NOMPON AS NOMPONCEN, ENDPONCEN.ENDPONATE AS ENDCEN, ENDPONCEN.NUMEND AS NUMCEN, 
                         ENDPONCEN.COMEND AS COMCEN, ENDPONCEN.BAI AS BAICEN, MUNPONCEN.NOMMUN AS MUNCEN, UFCEN.CODUF AS UFCEN, UFCEN.DESUF AS DESUFCEN, 
                         FILPONCEN.CODFIL AS CODFILPONCEN, FILPONCEN.NOMFIL AS NOMFILPONCEN, TIPLOGPONCEN.DESABRTIPLOG AS LOGCEN, 
                         CLIPONORI.CODCLI AS CODCLIORI, CLIPONORI.NOMCLI AS NOMCLIORI, CLIPONORI.NOMABRCLI AS NOMABRCLIORI, ISNULL(CAST(PONORI.CODCLI AS VARCHAR), 
                         0) + '/' + ISNULL(CAST(PONORI.NUMPONATE AS VARCHAR), 0) + '/' + ISNULL(CAST(PONORI.NUMPOSATE AS VARCHAR), 0) 
                         + '/' + ISNULL(CAST(PONORI.NUMATM AS VARCHAR), 0) + '  ' AS PONTOORITEM, PONORI.CODPONATE AS CODPONORI, PONORI.NUMPONATE AS NUMPONATEORI, 
                         PONORI.NUMPOSATE AS NUMPOSATEORI, PONORI.NUMATM AS NUMATMORI, PONORI.NOMPON AS NOMPONORI, ENDPONORI.ENDPONATE AS ENDORI, 
                         ENDPONORI.NUMEND AS NUMORI, ENDPONORI.COMEND AS COMORI, ENDPONORI.BAI AS BAIORI, MUNPONORI.NOMMUN AS MUNORI, UFORI.CODUF AS UFORI, 
                         UFORI.DESUF AS DESUFORI, FILPONORI.CODFIL AS CODFILPONORI, FILPONORI.NOMFIL AS NOMFILPONORI, TIPLOGPONORI.DESABRTIPLOG AS LOGORI, 
                         CLIPONDES.CODCLI AS CODCLIDES, CLIPONDES.NOMCLI AS NOMCLIDES, CLIPONDES.NOMABRCLI AS NOMABRCLIDES, 
                         ISNULL(CAST(PONDES.CODCLI AS VARCHAR), 0) + '/' + ISNULL(CAST(PONDES.NUMPONATE AS VARCHAR), 0) 
                         + '/' + ISNULL(CAST(PONDES.NUMPOSATE AS VARCHAR), 0) + '/' + ISNULL(CAST(PONDES.NUMATM AS VARCHAR), 0) + '  ' AS PONTODESTINO, 
                         PONDES.CODPONATE AS CODPONDES, PONDES.NUMPONATE AS NUMPONATEDES, PONDES.NUMPOSATE AS NUMPOSATEDES, 
                         PONDES.NUMATM AS NUMATMDES, PONDES.NOMPON AS NOMPONDES, ENDPONDES.ENDPONATE AS ENDDES, ENDPONDES.NUMEND AS NUMDES, 
                         ENDPONDES.COMEND AS COMDES, ENDPONDES.BAI AS BAIDES, MUNPONDES.NOMMUN AS MUNDES, UFDES.CODUF AS UFDES, UFDES.DESUF AS DESUFDES, 
                         FILPONDES.CODFIL AS CODFILPONDES, FILPONDES.NOMFIL AS NOMFILPONDES, TIPLOGPONDES.DESABRTIPLOG AS LOGDES, 
                         dbo.FAT_TCADPONENVFAMSER.CODPONENVFAMSER, FAT_TCADITEFAT_001_1.CODMOA, dbo.FAT_TCADCABDOCENT.CODTIPSER, dbo.FAT_TCADTIPSER.DESSER, 
                         CAST(FAT_TCADITEFAT_001_1.NRODOCENT AS VARCHAR(10)) AS NRODOCENT, FAT_TCADITEFAT_001_1.DATCOLSER, FAT_TCADITEFAT_001_1.DATENTSER, 
                         FAT_TCADITEFAT_001_1.HORCHESER, FAT_TCADITEFAT_001_1.HORSAISER, FAT_TCADITEFAT_001_1.VRMONCHE, FAT_TCADITEFAT_001_1.VRMONDIN, 
                         FAT_TCADITEFAT_001_1.VRMONOUT, FAT_TCADITEFAT_001_1.QTDEMB, TB_CODCALFAT.CODCALFAT AS CODCAL, TB_CODCALFAT.ADVALOREM, 
                         TB_CODCALFAT.MIN_EXCED AS MINUTOEXC, TB_CODCALFAT.CUSTODIA, TB_CODCALFAT.EMBARQUE, TB_CODCALFAT.VALOR_EMBARQUE, 
                         TB_CODCALFAT.MALOTE, TB_CODCALFAT.TARIFA_MENSAL AS TARIFAMENSAL, CASE ISNULL(RETRO.CODCOBREO, 0) WHEN 0 THEN 0 ELSE 1 END AS IDECOBREO,
                          ISNULL
                             ((SELECT        dbo.FAT_TCADIMPNOTFIS.VALIMP
                                 FROM            dbo.FAT_TCADIMPNOTFIS WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER WITH (NOLOCK) ON dbo.FAT_TCADIMPNOTFIS.CODTRI = dbo.FAT_TCADREPTRISOLSER.CODTRI
                                 WHERE        (dbo.FAT_TCADIMPNOTFIS.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (dbo.FAT_TCADIMPNOTFIS.CODTRI = 1) AND 
                                                          (dbo.FAT_TCADREPTRISOLSER.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER)), 0) AS ICMS, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_9.VALALI
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_9 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_9 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_9.CODTRI = FAT_TCADREPTRISOLSER_9.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_9.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_9.CODTRI = 1) AND 
                                                          (FAT_TCADREPTRISOLSER_9.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER) AND (ISNULL(FAT_TCADREPTRISOLSER_9.IDEREPTRI, 0) = 1)), 0) 
                         AS ICMS_ALI_REP, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_8.VALALI
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_8 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_8 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_8.CODTRI = FAT_TCADREPTRISOLSER_8.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_8.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_8.CODTRI = 1) AND 
                                                          (FAT_TCADREPTRISOLSER_8.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER)), 0) AS ICMS_ALI, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_7.VALIMPRED
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_7 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_7 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_7.CODTRI = FAT_TCADREPTRISOLSER_7.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_7.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_7.CODTRI = 1) AND 
                                                          (FAT_TCADIMPNOTFIS_7.IDEALIRED = 1) AND (FAT_TCADREPTRISOLSER_7.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER)), 0) AS ICMS_RED, 
                         ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_6.VALALIRED
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_6 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_6 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_6.CODTRI = FAT_TCADREPTRISOLSER_6.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_6.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_6.CODTRI = 1) AND 
                                                          (FAT_TCADIMPNOTFIS_6.IDEALIRED = 1) AND (FAT_TCADREPTRISOLSER_6.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER) AND 
                                                          (ISNULL(FAT_TCADREPTRISOLSER_6.IDEREPTRI, 0) = 1)), 0) AS ICMS_ALI_RED, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_5.VALIMP
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_5 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_5 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_5.CODTRI = FAT_TCADREPTRISOLSER_5.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_5.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_5.CODTRI = 2) AND 
                                                          (FAT_TCADREPTRISOLSER_5.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER)), 0) AS ISS, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_4.VALALI
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_4 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_4 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_4.CODTRI = FAT_TCADREPTRISOLSER_4.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_4.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_4.CODTRI = 2) AND 
                                                          (FAT_TCADREPTRISOLSER_4.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER)), 0) AS ISS_ALI, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_3.VALALI
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_3 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_3 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_3.CODTRI = FAT_TCADREPTRISOLSER_3.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_3.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_3.CODTRI = 2) AND 
                                                          (FAT_TCADREPTRISOLSER_3.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER) AND (ISNULL(FAT_TCADREPTRISOLSER_3.IDEREPTRI, 0) = 1)), 0) 
                         AS ISS_ALI_REP, dbo.FAT_TCADNOTFIS.CODUSU, dbo.FAT_TCADNOTFIS.DATEMI, 0 AS NUMSEQ, ISNULL(CREDEB.VALCREDEB, 0) AS VALCREDEB, 
                         TB_CODCALFAT.EMBARQUE_MENSALIZADO, TB_CODCALFAT.PERCENTUAL_SERVICOS, ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_2.VALIMPRED
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_2 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_2 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_2.CODTRI = FAT_TCADREPTRISOLSER_2.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_2.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_2.CODTRI = 2) AND 
                                                          (FAT_TCADIMPNOTFIS_2.IDEALIRED = 1) AND (FAT_TCADREPTRISOLSER_2.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER)), 0) AS ISS_RED, 
                         ISNULL
                             ((SELECT        FAT_TCADIMPNOTFIS_1.VALALIRED
                                 FROM            dbo.FAT_TCADIMPNOTFIS AS FAT_TCADIMPNOTFIS_1 WITH (NOLOCK) INNER JOIN
                                                          dbo.FAT_TCADREPTRISOLSER AS FAT_TCADREPTRISOLSER_1 WITH (NOLOCK) ON 
                                                          FAT_TCADIMPNOTFIS_1.CODTRI = FAT_TCADREPTRISOLSER_1.CODTRI
                                 WHERE        (FAT_TCADIMPNOTFIS_1.CODNOTFIS = dbo.FAT_TCADNOTFIS.CODNOTFIS) AND (FAT_TCADIMPNOTFIS_1.CODTRI = 2) AND 
                                                          (FAT_TCADIMPNOTFIS_1.IDEALIRED = 1) AND (FAT_TCADREPTRISOLSER_1.CODSOLSER = dbo.FAT_TCADSOLSER.CODSOLSER) AND 
                                                          (ISNULL(FAT_TCADREPTRISOLSER_1.IDEREPTRI, 0) = 1)), 0) AS ISS_ALI_RED, FAT_TCADITEFAT_001_1.NUMCHA, PONCEN.CODUNICLI, 
                         ISNULL(TB_CODCALFAT.VALOR_EMBARQUE_CONJUGADO, 0) AS VALOR_EMBARQUE_CONJUGADO, ISNULL(TB_CODCALFAT.VALOR_EXTRAORDINARIO, 0) 
                         AS VALOR_EXTRAORDINARIO, dbo.FAT_TCADPONENVFAMSER.NUMADICLI, dbo.FAT_TCADPONENVFAMSER.NUMCENCUS, 
                         ISNULL(FAT_TCADITEFAT_001_1.IDESERCON, 0) AS IDESERCON, FAT_TCADITEFAT_001_1.NUMKMROD, FAT_TCADITEFAT_001_1.NUMKMTOT, 
                         ISNULL(TB_CODCALFAT.VALOR_KM, 0) AS VALOR_KM, OSMSFAT.CODPONENVCLI, dbo.FAT_TCADESTABN.CODESTINTABN, dbo.FAT_TCADTIPSER.TIPREHSUP, 
                         ISNULL(FAT_TCADITEFAT_001_1.QTDMAL, 0) AS QTD_MALOTES, ISNULL(dbo.FAT_TCADNOTFIS.VALBONNOTFIS, 0) AS VALBONNOTFIS, 0 AS ALIQ_IMP_DED, 
                         0 AS VAL_IMP_DED, 0 AS ALIQ_IMP_RET, 0 AS VAL_IMP_RET, dbo.FAT_TCADNOTFIS.IDEPREFAT
FROM            dbo.FAT_TCADNOTFIS WITH (NOLOCK) INNER JOIN
                         dbo.FAT_TCADCABDOCENT WITH (NOLOCK) ON dbo.FAT_TCADNOTFIS.CODNOTFIS = dbo.FAT_TCADCABDOCENT.CODNOTFIS INNER JOIN
                             (SELECT        FAT_TCADCABDOCENT_1.CODCABDOCENT, MIN(ISNULL(ITEFAT.CODCALFAT, 0)) AS CODCALFAT, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 1 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS ADVALOREM, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 2 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS MIN_EXCED, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 2 THEN ISNULL(ITECOBSER.VALUNT, 0) ELSE 0 END) AS MIN_EXCEDVALUNT, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 3 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS CUSTODIA, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 4 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS EMBARQUE, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 5 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS MALOTE, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 6 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS TARIFA_MENSAL, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 14 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS EMBARQUE_MENSALIZADO, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 0 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS PERCENTUAL_SERVICOS, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 4 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS VALOR_EMBARQUE, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 13 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS VALOR_EMBARQUE_CONJUGADO, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 16 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS VALOR_EXTRAORDINARIO, 
                                                         SUM(CASE ITECOB.CODITECOBMAS WHEN 15 THEN ISNULL(VALCOB, 0) ELSE 0 END) AS VALOR_KM
                               FROM            dbo.FAT_TCADITECALFAT AS ITEFAT WITH (NOLOCK) INNER JOIN
                                                         dbo.FAT_TCADCABDOCENT AS FAT_TCADCABDOCENT_1 WITH (NOLOCK) ON 
                                                         FAT_TCADCABDOCENT_1.CODCABDOCENT = ITEFAT.CODCABDOCENT INNER JOIN
                                                         dbo.FAT_TCADITEFAT_001 WITH (NOLOCK) ON FAT_TCADCABDOCENT_1.CODCABDOCENT = dbo.FAT_TCADITEFAT_001.CODCABDOCENT INNER JOIN
                                                         dbo.FAT_TCADSEG WITH (NOLOCK) ON dbo.FAT_TCADSEG.CODSEG = FAT_TCADCABDOCENT_1.CODSEG INNER JOIN
                                                         dbo.FAT_TCADITECOB AS ITECOB WITH (NOLOCK) ON ITEFAT.CODITECOB = ITECOB.CODITECOB INNER JOIN
                                                         dbo.FAT_TCADITECOBSER AS ITECOBSER WITH (NOLOCK) ON ITEFAT.CODITECOBSER = ITECOBSER.CODITECOBSER LEFT OUTER JOIN
                                                         dbo.FAT_TCADITECOBSERAUT AS ITECOBSERAUT WITH (NOLOCK) ON ITECOBSERAUT.CODITECOBSER = ITECOBSER.CODITECOBSER AND 
                                                         dbo.FAT_TCADITEFAT_001.NUMAUT = ITECOBSERAUT.NUMAUT INNER JOIN
                                                         dbo.FAT_TCADNOTFIS AS FAT_TCADNOTFIS_1 WITH (NOLOCK) ON FAT_TCADNOTFIS_1.CODNOTFIS = ITEFAT.CODNOTFIS
                               WHERE        (dbo.FAT_TCADSEG.CODDIV = 1)
                               GROUP BY FAT_TCADCABDOCENT_1.CODCABDOCENT) AS TB_CODCALFAT ON 
                         TB_CODCALFAT.CODCABDOCENT = dbo.FAT_TCADCABDOCENT.CODCABDOCENT INNER JOIN
                         dbo.FAT_TCADSOLSER WITH (NOLOCK) ON dbo.FAT_TCADSOLSER.CODSOLSER = dbo.FAT_TCADCABDOCENT.CODSOLSER INNER JOIN
                         dbo.FAT_TCADOT WITH (NOLOCK) ON dbo.FAT_TCADSOLSER.CODSOLSER = dbo.FAT_TCADOT.CODSOLSER INNER JOIN
                         dbo.FAT_TCADFAMSEROT WITH (NOLOCK) ON dbo.FAT_TCADOT.CODOT = dbo.FAT_TCADFAMSEROT.CODOT INNER JOIN
                         dbo.FAT_TCADPONENVFAMSER WITH (NOLOCK) ON dbo.FAT_TCADFAMSEROT.CODFAMSEROT = dbo.FAT_TCADPONENVFAMSER.CODFAMSEROT AND 
                         dbo.FAT_TCADSOLSER.CODSOLSER = dbo.FAT_TCADCABDOCENT.CODSOLSER AND 
                         dbo.FAT_TCADPONENVFAMSER.CODPONENVFAMSER = dbo.FAT_TCADCABDOCENT.CODPONENV INNER JOIN
                         dbo.FAT_TTABFAM WITH (NOLOCK) ON dbo.FAT_TTABFAM.CODFAM = dbo.FAT_TCADFAMSEROT.CODFAM INNER JOIN
                         dbo.FAT_TCADSEG AS FAT_TCADSEG_1 WITH (NOLOCK) ON dbo.FAT_TTABFAM.CODSEG = FAT_TCADSEG_1.CODSEG INNER JOIN
                         dbo.FAT_TCADFIL WITH (NOLOCK) ON dbo.FAT_TCADFIL.CODFIL = dbo.FAT_TCADPONENVFAMSER.CODFILORINOTFIS INNER JOIN
                         dbo.FAT_TCADSERPONENV WITH (NOLOCK) ON dbo.FAT_TCADSERPONENV.CODSERPONENV = dbo.FAT_TCADCABDOCENT.CODSERPONENV AND 
                         dbo.FAT_TCADPONENVFAMSER.CODPONENVFAMSER = dbo.FAT_TCADSERPONENV.CODPONENVFAMSER INNER JOIN
                         dbo.FAT_TTABMUN AS MUNFIL WITH (NOLOCK) ON MUNFIL.CODMUN = dbo.FAT_TCADFIL.CODMUN INNER JOIN
                         dbo.FAT_TCADITEFAT_001 AS FAT_TCADITEFAT_001_1 WITH (NOLOCK) ON 
                         dbo.FAT_TCADCABDOCENT.CODCABDOCENT = FAT_TCADITEFAT_001_1.CODCABDOCENT INNER JOIN
                         dbo.FAT_TTABEMP WITH (NOLOCK) ON dbo.FAT_TCADNOTFIS.CODEMP = dbo.FAT_TTABEMP.CODEMP INNER JOIN
                         dbo.FAT_TCADPONATE AS PONFAT WITH (NOLOCK) ON PONFAT.CODPONATE = dbo.FAT_TCADPONENVFAMSER.CODPONATEFAT INNER JOIN
                         dbo.FAT_TCADCLI AS CLIPONFAT WITH (NOLOCK) ON CLIPONFAT.CODCLI = PONFAT.CODCLI INNER JOIN
                         dbo.FAT_TCADFIL AS FILPONFAT WITH (NOLOCK) ON FILPONFAT.CODFIL = PONFAT.CODFILPONATEPET LEFT OUTER JOIN
                         dbo.FAT_TCADLOCPONATE AS ENDPONFAT WITH (NOLOCK) ON PONFAT.CODLOCPONATE = ENDPONFAT.CODLOCPONATE LEFT OUTER JOIN
                         dbo.FAT_TTABTIPLOG AS TIPLOGPONFAT WITH (NOLOCK) ON TIPLOGPONFAT.CODTIPLOG = ENDPONFAT.CODTIPLOG LEFT OUTER JOIN
                         dbo.FAT_TTABMUN AS MUNPONFAT WITH (NOLOCK) ON MUNPONFAT.CODMUN = ENDPONFAT.CODMUN LEFT OUTER JOIN
                         dbo.FAT_TTABUF AS UFFAT WITH (NOLOCK) ON UFFAT.CODUF = MUNPONFAT.CODUF INNER JOIN
                         dbo.FAT_TCADPONATE AS PONCEN WITH (NOLOCK) ON PONCEN.CODPONATE = dbo.FAT_TCADPONENVFAMSER.CODPONATECENCUS INNER JOIN
                         dbo.FAT_TCADCLI AS CLIPONCEN WITH (NOLOCK) ON CLIPONCEN.CODCLI = PONCEN.CODCLI INNER JOIN
                         dbo.FAT_TCADFIL AS FILPONCEN WITH (NOLOCK) ON FILPONCEN.CODFIL = PONCEN.CODFILPONATEPET LEFT OUTER JOIN
                         dbo.FAT_TCADLOCPONATE AS ENDPONCEN WITH (NOLOCK) ON PONCEN.CODLOCPONATE = ENDPONCEN.CODLOCPONATE LEFT OUTER JOIN
                         dbo.FAT_TTABTIPLOG AS TIPLOGPONCEN WITH (NOLOCK) ON TIPLOGPONCEN.CODTIPLOG = ENDPONCEN.CODTIPLOG LEFT OUTER JOIN
                         dbo.FAT_TTABMUN AS MUNPONCEN WITH (NOLOCK) ON MUNPONCEN.CODMUN = ENDPONCEN.CODMUN LEFT OUTER JOIN
                         dbo.FAT_TTABUF AS UFCEN WITH (NOLOCK) ON UFCEN.CODUF = MUNPONCEN.CODUF INNER JOIN
                         dbo.FAT_TCADPONATE AS PONORI WITH (NOLOCK) ON PONORI.CODPONATE = FAT_TCADITEFAT_001_1.CODPONORI INNER JOIN
                         dbo.FAT_TCADCLI AS CLIPONORI WITH (NOLOCK) ON CLIPONORI.CODCLI = PONORI.CODCLI INNER JOIN
                         dbo.FAT_TCADFIL AS FILPONORI WITH (NOLOCK) ON FILPONORI.CODFIL = PONORI.CODFILPONATEPET LEFT OUTER JOIN
                         dbo.FAT_TCADLOCPONATE AS ENDPONORI WITH (NOLOCK) ON PONORI.CODLOCPONATE = ENDPONORI.CODLOCPONATE LEFT OUTER JOIN
                         dbo.FAT_TTABTIPLOG AS TIPLOGPONORI WITH (NOLOCK) ON TIPLOGPONORI.CODTIPLOG = ENDPGHHONORI.CODTIPLOG LEFT OUTER JOIN
                         dbo.FAT_TTABMUN AS MUNPONORI WITH (NOLOCK) ON MUNPONORI.CODMUN = ENDPONORI.CO	DMUN LEFT OUTER JOIN
                         dbo.FAT_TTABUF AS UFORI WITH (NOLOCK) ON UFORI.CODUF = MUNPONORI.CODUF INNER JOIN
                         dbo.FAT_TCADPONATE AS PONDES WITH (NOLOCK) ON PONDES.CODPONATE = FAT_TCADITEFAT_001_1.CODPONDES INNER JOIN
                         dbo.FAT_TCADCLI AS CLIPONDES WITH (NOLOCK) ON CLIPONDES.CODCLI = PONDES.CODCLI INNER JOIN
                         dbo.FAT_TCADFIL AS FILPONDES WITH (NOLOCK) ON FILPONDES.CODFIL = PONDES.CODFILPONATEPET LEFT OUTER JOIN
                         dbo.FAT_TCADLOCPONATE AS ENDPONDES WITH (NOLOCK) ON PONDES.CODLOCPONATE = ENDPONDES.CODLOCPONATE LEFT OUTER JOIN
                         dbo.FAT_TTABTIPLOG AS TIPLOGPONDES WITH (NOLOCK) ON TIPLOGPONDES.CODTIPLOG = ENDPONDES.CODTIPLOG LEFT OUTER JOIN
                         dbo.FAT_TTABMUN AS MUNPONDES WITH (NOLOCK) ON MUNPONDES.CODMUN = ENDPONDES.CODMUN LEFT OUTER JOIN
                         dbo.FAT_TTABUF AS UFDES WITH (NOLOCK) ON UFDES.CODUF = MUNPONDES.CODUF INNER JOIN
                         dbo.FAT_TCADTIPSER WITH (NOLOCK) ON dbo.FAT_TCADCABDOCENT.CODTIPSER = dbo.FAT_TCADTIPSER.CODTIPSER INNER JOIN
                         dbo.FAT_TTABMOA WITH (NOLOCK) ON dbo.FAT_TTABMOA.CODMOA = FAT_TCADITEFAT_001_1.CODMOA LEFT OUTER JOIN
                         dbo.FAT_TCADCOBREODOCENT AS RETRO WITH (NOLOCK) ON dbo.FAT_TCADCABDOCENT.CODCABDOCENT = RETRO.CODCABDOCENT LEFT OUTER JOIN
                             (SELECT        CODNOTFIS, MESCOP, ANOCOP, CODPONENVFAMSER, CODSERPONENV, SUM(VALCREDEB) AS VALCREDEB
                               FROM            dbo.FAT_TCADCREDEBNOTFIS AS CD WITH (NOLOCK)
                               GROUP BY CODNOTFIS, MESCOP, ANOCOP, CODPONENVFAMSER, CODSERPONENV) AS CREDEB ON 
                         CREDEB.CODNOTFIS = dbo.FAT_TCADCABDOCENT.CODNOTFIS AND CREDEB.CODPONENVFAMSER = dbo.FAT_TCADCABDOCENT.CODPONENV AND 
                         CREDEB.CODSERPONENV = dbo.FAT_TCADCABDOCENT.CODSERPONENV AND CREDEB.MESCOP = dbo.FAT_TCADCABDOCENT.MESCOPDOC AND 
                         CREDEB.ANOCOP = dbo.FAT_TCADCABDOCENT.ANOCOPDOC LEFT OUTER JOIN
                         dbo.FAT_TCADREITIPMOASERCLI AS OSMSFAT WITH (NOLOCK) ON OSMSFAT.CODCLI = dbo.FAT_TCADCABDOCENT.CODCLI AND 
                         OSMSFAT.CODPONENVFAMSER = dbo.FAT_TCADPONENVFAMSER.CODPONENVFAMSER AND OSMSFAT.CODTIPSER = dbo.FAT_TCADCABDOCENT.CODTIPSER AND 
                         OSMSFAT.CODMOA = FAT_TCADITEFAT_001_1.CODMOA LEFT OUTER JOIN
                         dbo.FAT_TCADESTABN WITH (NOLOCK) ON dbo.FAT_TCADESTABN.CODESTABN = dbo.FAT_TCADSERPONENV.CODESTABN